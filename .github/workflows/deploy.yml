name: Deploy to EC2 via SSM

on:
  push:
    branches: [main]

jobs:
  # 1. 빌드 및 ECR 푸시
  build-and-push:
    runs-on: ubuntu-latest

    env:
      AWS_REGION: ${{ secrets.AWS_REGION }}
      ECR_URI: ${{ secrets.AWS_ECR_URI }}
      IMAGE_REPO: dev/alpha-repo

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: npm ci

      - name: Run tests
        run: npm test

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v5
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Login to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build and push docker image
        env:
          ECR_URI: ${{ secrets.AWS_ECR_URI }}
          IMAGE_REPO: dev/alpha-repo
        run: |
          IMAGE_TAG=latest
          BUILD_TAG=${GITHUB_RUN_NUMBER:-${GITHUB_RUN_ID}}
          FULL_IMAGE="${ECR_URI}/${IMAGE_REPO}"
          # Build
          docker build --build-arg NODE_ENV=production -t ${FULL_IMAGE}:${IMAGE_TAG} .
          docker tag ${FULL_IMAGE}:${IMAGE_TAG} ${FULL_IMAGE}:${BUILD_TAG}
          # Push both tags
          docker push ${FULL_IMAGE}:${IMAGE_TAG}
          docker push ${FULL_IMAGE}:${BUILD_TAG}

  # 2. SSM을 통한 배포
  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    env:
      ECR_REGISTRY: ${{ secrets.AWS_ECR_URI }}
      IMAGE_REPO: dev/alpha-repo
      CONTAINER_NAME: alpha-server
      HOST_PORT: 80 # EC2에서 열어줄 포트
      CONTAINER_PORT: 3000 # Node.js 앱이 사용하는 포트

    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Deploy to EC2 via SSM
        run: |
          # 1. EC2에서 실행할 로직을 파일로 먼저 작성합니다.
          # (여전히 Parameter Store를 사용하는 방식입니다)
          cat <<EOF > deploy_script.sh
          #!/bin/bash
          # 에러 발생 시 즉시 중단
          set -e

          # ECR 로그인
          aws ecr get-login-password --region ${{ secrets.AWS_REGION }} | docker login --username AWS --password-stdin $ECR_REGISTRY

          # Parameter Store에서 .env 안전하게 가져오기
          # (따옴표가 있어도 Base64로 감싸져서 전송되므로 안전함)
          aws ssm get-parameter --name "/alpha/dev/env" --with-decryption --query "Parameter.Value" --output text > .env

          # Docker 배포
          docker pull $ECR_REGISTRY/$IMAGE_REPO:latest
          docker stop $CONTAINER_NAME || true
          docker rm $CONTAINER_NAME || true
          docker run -d --name $CONTAINER_NAME -p $HOST_PORT:$CONTAINER_PORT --env-file .env --restart always $ECR_REGISTRY/$IMAGE_REPO:latest

          # 정리
          docker image prune -f
          rm .env
          EOF

          # 2. 작성된 스크립트 파일을 Base64로 인코딩 (줄바꿈 제거)
          ENCODED_COMMAND=$(base64 -w 0 deploy_script.sh)

          # 3. SSM 명령 전송
          # EC2에는 "인코딩된 문자열을 풀어서 실행하라"는 아주 단순한 명령만 전달됩니다.
          # 따라서 따옴표 파싱 에러가 발생할 수 없습니다.
          echo "Sending deployment command to EC2..."

          SH_COMMAND_ID=$(aws ssm send-command \
            --document-name "AWS-RunShellScript" \
            --targets "Key=instanceids,Values=${{ secrets.AWS_EC2_INSTANCE_ID }}" \
            --comment "Deploying Node.js App via Encoded Script" \
            --parameters "commands=echo $ENCODED_COMMAND | base64 -d | bash" \
            --query "Command.CommandId" \
            --output text)

          echo "Command ID: $SH_COMMAND_ID"

          # 4. 배포 결과 확인 (Polling)
          echo "Waiting for command execution..."
          sleep 2 

          aws ssm wait command-executed \
            --command-id "$SH_COMMAND_ID" \
            --instance-id "${{ secrets.AWS_EC2_INSTANCE_ID }}"

          STATUS=$(aws ssm get-command-invocation \
            --command-id "$SH_COMMAND_ID" \
            --instance-id "${{ secrets.AWS_EC2_INSTANCE_ID }}" \
            --query "Status" --output text)
            
          echo "Deployment Status: $STATUS"

          if [ "$STATUS" != "Success" ]; then
            echo "Deployment Failed"
            # 실패 시 상세 로그 출력 (디버깅용)
            aws ssm get-command-invocation \
              --command-id "$SH_COMMAND_ID" \
              --instance-id "${{ secrets.AWS_EC2_INSTANCE_ID }}" \
              --query "StandardErrorContent" --output text
            exit 1
          fi
