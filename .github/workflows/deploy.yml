name: Deploy to EC2 via SSM

on:
  push:
    branches: [main]

jobs:
  # 1. 빌드 및 ECR 푸시
  build-and-push:
    runs-on: ubuntu-latest

    env:
      AWS_REGION: ${{ secrets.AWS_REGION }}
      ECR_URI: ${{ secrets.AWS_ECR_URI }}
      IMAGE_REPO: dev/alpha-repo

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: npm ci

      - name: Run tests
        run: npm test

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v5
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Login to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build and push docker image
        env:
          ECR_URI: ${{ secrets.AWS_ECR_URI }}
          IMAGE_REPO: dev/alpha-repo
        run: |
          IMAGE_TAG=latest
          BUILD_TAG=${GITHUB_RUN_NUMBER:-${GITHUB_RUN_ID}}
          FULL_IMAGE="${ECR_URI}/${IMAGE_REPO}"
          # Build
          docker build --build-arg NODE_ENV=production -t ${FULL_IMAGE}:${IMAGE_TAG} .
          docker tag ${FULL_IMAGE}:${IMAGE_TAG} ${FULL_IMAGE}:${BUILD_TAG}
          # Push both tags
          docker push ${FULL_IMAGE}:${IMAGE_TAG}
          docker push ${FULL_IMAGE}:${BUILD_TAG}

  # 2. SSM을 통한 배포
  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    env:
      ECR_REGISTRY: ${{ secrets.AWS_ECR_URI }}
      IMAGE_REPO: dev/alpha-repo
      CONTAINER_NAME: alpha-server
      HOST_PORT: 80 # EC2에서 열어줄 포트
      CONTAINER_PORT: 3000 # Node.js 앱이 사용하는 포트

    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Deploy to EC2 via SSM
        run: |
          # 1. EC2 내부에서 실행될 스크립트 작성
          # 설명: ECR 로그인 -> 이미지 Pull -> 기존 컨테이너 중지/삭제 -> 새 컨테이너 실행 -> 찌꺼기 정리
          COMMANDS=$(cat <<EOF
            aws ecr get-login-password --region ${{ secrets.AWS_REGION }} | docker login --username AWS --password-stdin $ECR_REGISTRY
            
            # AWS Parameter Store에서 .env 내용 가져와서 파일 만들기
            aws ssm get-parameter \
              --name '/alpha/dev/env' \
              --with-decryption \
              --query 'Parameter.Value' \
              --output text > .env
            
            docker pull $ECR_REGISTRY/$IMAGE_REPO:latest
            docker stop $CONTAINER_NAME || true
            docker rm $CONTAINER_NAME || true
            
            docker run -d \
              --name $CONTAINER_NAME \
              -p $HOST_PORT:$CONTAINER_PORT \
              --env-file .env \
              --restart always \
              $ECR_REGISTRY/$IMAGE_REPO:latest
              
            docker image prune -f
          EOF
          )

          # 2. SSM 명령 전송
          echo "Sending deployment command to EC2..."
          SH_COMMAND_ID=$(aws ssm send-command \
            --document-name "AWS-RunShellScript" \
            --targets "Key=instanceids,Values=${{ secrets.AWS_EC2_INSTANCE_ID }}" \
            --comment "Deploying Node.js App" \
            --parameters "commands=$COMMANDS" \
            --query "Command.CommandId" \
            --output text)

          echo "Command ID: $SH_COMMAND_ID"

          # 3. 배포 결과 확인 (Polling)
          # 명령이 끝날 때까지 기다렸다가 성공/실패 여부를 판단합니다.
          echo "Waiting for command execution..."
          sleep 2 

          aws ssm wait command-executed \
            --command-id "$SH_COMMAND_ID" \
            --instance-id "${{ secrets.AWS_EC2_INSTANCE_ID }}"

          # 최종 상태 조회
          STATUS=$(aws ssm get-command-invocation \
            --command-id "$SH_COMMAND_ID" \
            --instance-id "${{ secrets.AWS_EC2_INSTANCE_ID }}" \
            --query "Status" --output text)
            
          echo "Deployment Status: $STATUS"

          if [ "$STATUS" != "Success" ]; then
            echo "Deployment Failed!"
            exit 1
          fi
